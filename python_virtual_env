export _VIRTUAL_ENV_HOME=$HOME/.pyenv

function _ensure_home() {
    if [[ -d $_VIRTUAL_ENV_HOME ]]; then
        return
    fi
    echo "_VIRTUAL_ENV_HOME($_VIRTUAL_ENV_HOME) does not exist. Create it!"
    mkdir -p $_VIRTUAL_ENV_HOME
}

function pyactivate() {
    env=${1:?"env is required"}
    _ensure_home
    source $_VIRTUAL_ENV_HOME/$env/bin/activate
}

function pylist() {
    _ensure_home
    ls $_VIRTUAL_ENV_HOME
}

function pycreate() {
    env=${1:?"env is required"}
    virtualenv=${2:-"virtualenv"}
    _ensure_home
    eval "$virtualenv $_VIRTUAL_ENV_HOME/$env"
}

function _completevenvs {
    local curw=${COMP_WORDS[COMP_CWORD]}
    _ensure_home > /dev/null
    local wordlist=$(ls "$_VIRTUAL_ENV_HOME")
    COMPREPLY=($(compgen -W '${wordlist[@]}' -- "$curw"))
    return 0
}

complete -F _completevenvs pyactivate 
